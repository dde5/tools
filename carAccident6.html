<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­ç‰ˆè»Šç¦å’Œè§£æ›¸ç”¢ç”Ÿå™¨ (è·¨å¹³å°ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: system-ui, -apple-system, "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* === iOS Date Input Fix (é—œéµä¿®æ­£) === */
        input[type="date"], input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            min-height: 42px; /* å¼·åˆ¶é«˜åº¦é¿å… iOS å¡Œé™· */
            line-height: 1.5;
        }
        
        /* Modal & Loader */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 5% auto; width: 95%; max-width: 600px; border-radius: 12px; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        #disclaimerModal .modal-content { height: auto; max-height: 90vh; overflow-y: auto; }

        /* Signature Pad */
        .sig-wrapper { flex: 1; min-height: 200px; background: #fff; position: relative; }
        #signature-pad { width: 100%; height: 100%; touch-action: none; }
        
        /* Loader */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column;}
        .loader { border: 5px solid #e5e7eb; border-top: 5px solid #dc2626; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Photo Grid */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 10px; }
        .photo-item { position: relative; width: 100%; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid #e5e7eb; background: #fff; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-delete { position: absolute; top: 0; right: 0; background: rgba(239, 68, 68, 0.9); color: white; font-size: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; border-bottom-left-radius: 6px;}

        /* Hidden PDF Areas */
        #preview-container { position: absolute; left: -9999px; top: 0; }
        .pdf-page { width: 794px; min-height: 1123px; background: white; color: #1f2937; padding: 50px 60px; position: relative; box-sizing: border-box; }
        
        /* PDF Typography */
        .pdf-title { font-size: 26px; font-weight: bold; text-align: center; border-bottom: 3px solid #1f2937; padding-bottom: 12px; margin-bottom: 20px; letter-spacing: 2px; }
        .pdf-section-title { font-size: 16px; font-weight: bold; border-left: 4px solid #1f2937; padding-left: 10px; margin-top: 24px; margin-bottom: 12px; background: #f9fafb; padding-top: 4px; padding-bottom: 4px;}
        .pdf-text { font-size: 14px; line-height: 1.6; margin-bottom: 6px; text-align: justify; }
        .pdf-highlight { color: #dc2626; font-weight: bold; }
        
        .pdf-party-box { display: flex; gap: 20px; margin-bottom: 10px; border: 1px solid #e5e7eb; padding: 10px; border-radius: 4px; }
        .pdf-party-col { flex: 1; font-size: 13px; line-height: 1.5; }
        .pdf-party-col strong { font-size: 14px; display: block; margin-bottom: 4px; border-bottom: 1px solid #ccc; padding-bottom: 2px;}

        .pdf-list { list-style-type: decimal; padding-left: 24px; font-size: 14px; line-height: 1.8; }
        .pdf-list li { margin-bottom: 8px; padding-left: 6px; }
        
        /* Signatures in PDF */
        .pdf-sig-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px; border-top: 2px solid #e5e7eb; padding-top: 20px; }
        .pdf-sig-box { flex: 1; min-width: 45%; border: 1px solid #e5e7eb; padding: 10px; border-radius: 4px; page-break-inside: avoid; }
        .pdf-sig-img { height: 60px; width: 100%; object-fit: contain; border-bottom: 1px solid #9ca3af; margin-bottom: 5px; }

        .footer-note { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; font-size: 10px; color: #9ca3af; }
        
        /* Selection Box */
        .radio-box { border: 1px solid #e5e7eb; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: start; gap: 10px; margin-bottom: 8px; }
        .radio-box:hover { background-color: #f9fafb; }
        .radio-box.selected { border-color: #2563eb; background-color: #eff6ff; }
        .radio-box input { margin-top: 4px; }

        /* Validation Error Text */
        .error-msg { color: #dc2626; font-size: 12px; margin-top: 2px; display: none; }
    </style>
</head>
<body class="pb-32">

<!-- Disclaimer Modal -->
<div id="disclaimerModal" class="modal" style="display: flex;">
    <div class="modal-content p-6">
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <span class="text-2xl">âš ï¸</span>
            </div>
            <h2 class="text-xl font-bold text-gray-900">ä½¿ç”¨å‰è«‹å‹™å¿…é–±è®€</h2>
        </div>
        <div class="text-sm text-gray-700 space-y-3 overflow-y-auto flex-1 mb-4 border p-3 rounded bg-gray-50">
            <p class="font-bold">æœ¬å·¥å…·åƒ…é©ç”¨æ–¼ã€Œå–®ç´”è²¡æï¼ˆç„¡äººå—å‚·ï¼‰ã€ä¸”ã€Œé›™æ–¹å°è³ å„Ÿç„¡ç•°è­°ã€ä¹‹æ¡ˆä»¶ã€‚</p>
            <p>è‹¥ç¬¦åˆä»¥ä¸‹ä»»ä¸€æƒ…æ³ï¼Œå»ºè­°å ±è­¦ä¸¦è«®è©¢å°ˆæ¥­å¾‹å¸«ï¼Œæœ¬å·¥å…·ç”¢å‡ºä¹‹æ–‡ä»¶å¯èƒ½ä¸è¶³ä»¥ä¿éšœæ‚¨çš„æ¬Šç›Šï¼š</p>
            <ul class="list-disc pl-5 space-y-1 text-gray-600">
                <li>æœ‰äººå“¡å—å‚·æˆ–æ­»äº¡ï¼ˆæ¶‰åŠéå¤±å‚·å®³/è‡´æ­»ï¼‰ã€‚</li>
                <li>ä»»ä¸€æ–¹æœªæ»¿ 18 æ­²ï¼Œä¸”ç„¡æ³•å®šä»£ç†äººé™ªåŒã€‚</li>
                <li>é§•é§›äººä¸¦éè»Šä¸»ï¼Œä¸”æœªç²è»Šä¸»æˆæ¬Šã€‚</li>
                <li>è³ å„Ÿé‡‘é¡é¾å¤§æˆ–æ¶‰åŠä¿éšªç†è³ çˆ­è­°ã€‚</li>
            </ul>
            <p class="text-xs text-gray-500 mt-2">å…è²¬è²æ˜ï¼šæœ¬å·¥å…·åƒ…æä¾›æ ¼å¼ç”Ÿæˆï¼Œä¸ä»£è¡¨æ³•å¾‹è«®è©¢ã€‚é–‹ç™¼è€…ä¸å°ä½¿ç”¨è€…å› ä½¿ç”¨æœ¬å·¥å…·ç”¢ç”Ÿä¹‹æ³•å¾‹ç³¾ç´›è² è²¬ã€‚</p>
        </div>
        <button onclick="document.getElementById('disclaimerModal').style.display='none'" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">
            æˆ‘å·²äº†è§£ä¸¦åŒæ„ä½¿ç”¨
        </button>
    </div>
</div>

<!-- Loader -->
<div id="loader" class="loader-overlay">
    <div class="loader"></div>
    <p class="mt-4 text-gray-800 font-bold text-lg">æ­£åœ¨è£½ä½œæ­£å¼æ³•å¾‹æ–‡ä»¶...</p>
    <p class="text-sm text-gray-500">æ­£åœ¨ç”Ÿæˆé¨ç¸«ç« èˆ‡åŠ å¯† PDF</p>
</div>

<!-- Signature Modal -->
<div id="sigModal" class="modal">
    <div class="modal-content h-3/4">
        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg" id="sigModalTitle">ç°½å</h3>
            <button onclick="closeSigModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none px-2">&times;</button>
        </div>
        <div class="sig-wrapper">
            <canvas id="signature-pad"></canvas>
        </div>
        <div class="p-3 bg-gray-50 border-t flex justify-between gap-3">
            <button onclick="clearCurrentPad()" class="px-5 py-2 text-red-600 border border-red-200 bg-white rounded hover:bg-red-50">æ¸…é™¤</button>
            <button onclick="saveSignature()" class="flex-1 px-5 py-2 bg-blue-600 text-white rounded font-bold shadow hover:bg-blue-700">ç¢ºèªç°½ç½²</button>
        </div>
    </div>
</div>

<div class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl">
    <div class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-5 sticky top-0 z-20 shadow-md flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold">è»Šç¦å’Œè§£æ›¸ç”¢ç”Ÿå™¨</h1>
            <p class="text-xs text-slate-400">å°ˆæ¥­å¾‹å¸«ç›£ä¿®ç‰ˆ v2.4 (Android/iOSä¿®æ­£)</p>
        </div>
        <div class="text-xs bg-red-700 px-2 py-1 rounded text-white border border-red-500 shadow">â˜… é›™é é¨ç¸«ç« </div>
    </div>

    <form id="settlementForm" class="p-5 space-y-8">
        
        <!-- 1. äº‹æ•…è³‡è¨Š -->
        <section class="space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">1</span>
                <h2 class="text-gray-900 font-bold text-lg">äº‹æ•…åŸºæœ¬è³‡è¨Š</h2>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-500">æ—¥æœŸ</label>
                    <input type="date" id="incidentDate" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white">
                </div>
                <div>
                    <label class="text-xs text-gray-500">æ™‚é–“</label>
                    <input type="time" id="incidentTime" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white">
                </div>
            </div>
            
            <div class="relative">
                <input type="text" id="incidentLocation" placeholder="è¼¸å…¥äº‹æ•…åœ°é»" class="w-full border border-gray-300 rounded-lg p-2.5 pr-12 bg-white">
                <button type="button" onclick="getLocation()" class="absolute right-1 top-1 bottom-1 w-10 bg-green-100 text-green-600 rounded-md flex items-center justify-center hover:bg-green-200">
                    ğŸ“
                </button>
            </div>

            <div class="space-y-2">
                <select id="incidentType" onchange="toggleCustomType()" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white">
                    <option value="è»Šè¼›æ“¦æ’">è»Šè¼›æ“¦æ’</option>
                    <option value="è¿½æ’å‰æ–¹è»Šè¼›">è¿½æ’å‰æ–¹è»Šè¼›</option>
                    <option value="è®Šæ›è»Šé“ä¸ç•¶">è®Šæ›è»Šé“ä¸ç•¶</option>
                    <option value="å€’è»Šç¢°æ’">å€’è»Šç¢°æ’</option>
                    <option value="å…¶ä»–">å…¶ä»– (è‡ªè¡Œæè¿°)</option>
                </select>
                <input type="text" id="incidentTypeCustom" placeholder="è«‹æè¿°äº‹æ•… (ä¾‹: æ©Ÿè»Šå·¦è½‰èˆ‡ç›´è¡Œè»Šç¢°æ’)" class="hidden w-full border border-yellow-300 rounded-lg p-2.5 bg-yellow-50">
            </div>

            <div class="flex items-start gap-3 bg-red-50 p-3 rounded-lg border border-red-100">
                <input type="checkbox" id="noInjuryCheck" class="mt-1 w-5 h-5 text-red-600 rounded">
                <label for="noInjuryCheck" class="text-sm text-red-800">
                    <span class="font-bold">ç¢ºèªé›™æ–¹ç•¶ä¸‹ã€Œå‡ç„¡å—å‚·ã€</span>
                    <br><span class="text-xs text-red-600 opacity-80">*è‹¥æœ‰äººå“¡å—å‚·ï¼Œå¼·çƒˆå»ºè­°å ±è­¦ä¸¦ç”±è­¦æ–¹è™•ç†ï¼Œå‹¿ç§ä¸‹å’Œè§£ã€‚</span>
                </label>
            </div>
        </section>

        <hr class="border-gray-200">

        <!-- 2. ç•¶äº‹äºº (ç”²æ–¹) -->
        <section class="space-y-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">2</span>
                    <h2 class="text-blue-900 font-bold text-lg">ç”²æ–¹ (Party A)</h2>
                </div>
                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">é€šå¸¸ç‚ºè³ å„Ÿæ–¹</span>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-1">
                        <label class="text-xs text-blue-600 font-bold ml-1">å§“å</label>
                        <input type="text" id="nameA" class="w-full border border-blue-200 rounded p-2 text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-blue-600 font-bold ml-1">èº«åˆ†è­‰å­—è™Ÿ</label>
                        <input type="text" id="idA" onblur="validateID(this)" class="w-full border border-blue-200 rounded p-2 text-sm uppercase">
                        <p class="error-msg" id="errorIdA"></p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-blue-600 font-bold ml-1">å‡ºç”Ÿå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="dobA" onchange="checkAge('A')" class="w-full border border-blue-200 rounded p-2 text-sm bg-white">
                    </div>
                    <div>
                         <label class="text-xs text-blue-600 font-bold ml-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phoneA" class="w-full border border-blue-200 rounded p-2 text-sm">
                    </div>
                </div>

                <div class="flex items-center gap-2 pt-1">
                    <input type="checkbox" id="isOwnerA" checked class="w-4 h-4 text-blue-600">
                    <label for="isOwnerA" class="text-sm text-blue-900">é§•é§›äººå³ç‚ºè»Šä¸»</label>
                </div>
                <div id="plateGroupA" class="pt-1">
                    <input type="text" id="plateA" placeholder="è»Šç‰Œè™Ÿç¢¼" class="w-full border border-blue-200 rounded p-2 text-sm bg-white">
                </div>

                <div id="repAreaA" class="hidden bg-white p-3 rounded border border-red-200 mt-2">
                    <p class="text-xs text-red-600 font-bold mb-2">âš ï¸ ç”²æ–¹æœªæ»¿ 18 æ­²ï¼Œéœ€æ³•å®šä»£ç†äºº</p>
                    <input type="text" id="repNameA" placeholder="æ³•å®šä»£ç†äººå§“å" class="w-full border rounded p-2 text-sm mb-2">
                    <input type="text" id="repIdA" placeholder="æ³•å®šä»£ç†äººèº«åˆ†è­‰" onblur="validateID(this)" class="w-full border rounded p-2 text-sm uppercase">
                    <p class="error-msg" id="errorIdRepA"></p>
                </div>
            </div>
        </section>

        <!-- 2. ç•¶äº‹äºº (ä¹™æ–¹) -->
        <section class="space-y-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="bg-orange-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">3</span>
                    <h2 class="text-orange-900 font-bold text-lg">ä¹™æ–¹ (Party B)</h2>
                </div>
                <span class="text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded">é€šå¸¸ç‚ºå—ææ–¹</span>
            </div>

            <div class="bg-orange-50 p-4 rounded-xl border border-orange-200 space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-1">
                        <label class="text-xs text-orange-800 font-bold ml-1">å§“å</label>
                        <input type="text" id="nameB" class="w-full border border-orange-200 rounded p-2 text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-orange-800 font-bold ml-1">èº«åˆ†è­‰å­—è™Ÿ</label>
                        <input type="text" id="idB" onblur="validateID(this)" class="w-full border border-orange-200 rounded p-2 text-sm uppercase">
                        <p class="error-msg" id="errorIdB"></p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-orange-800 font-bold ml-1">å‡ºç”Ÿå¹´æœˆæ—¥ <span class="text-red-500">*</span></label>
                        <input type="date" id="dobB" onchange="checkAge('B')" class="w-full border border-orange-200 rounded p-2 text-sm bg-white">
                    </div>
                    <div>
                         <label class="text-xs text-orange-800 font-bold ml-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phoneB" class="w-full border border-orange-200 rounded p-2 text-sm">
                    </div>
                </div>

                <div class="flex items-center gap-2 pt-1">
                    <input type="checkbox" id="isOwnerB" checked class="w-4 h-4 text-orange-600">
                    <label for="isOwnerB" class="text-sm text-orange-900">é§•é§›äººå³ç‚ºè»Šä¸»</label>
                </div>
                <div id="plateGroupB" class="pt-1">
                    <input type="text" id="plateB" placeholder="è»Šç‰Œè™Ÿç¢¼" class="w-full border border-orange-200 rounded p-2 text-sm bg-white">
                </div>

                <div id="repAreaB" class="hidden bg-white p-3 rounded border border-red-200 mt-2">
                    <p class="text-xs text-red-600 font-bold mb-2">âš ï¸ ä¹™æ–¹æœªæ»¿ 18 æ­²ï¼Œéœ€æ³•å®šä»£ç†äºº</p>
                    <input type="text" id="repNameB" placeholder="æ³•å®šä»£ç†äººå§“å" class="w-full border rounded p-2 text-sm mb-2">
                    <input type="text" id="repIdB" placeholder="æ³•å®šä»£ç†äººèº«åˆ†è­‰" onblur="validateID(this)" class="w-full border rounded p-2 text-sm uppercase">
                    <p class="error-msg" id="errorIdRepB"></p>
                </div>
            </div>
        </section>

        <hr class="border-gray-200">

        <!-- 3. å’Œè§£æ¢ä»¶ -->
        <section class="space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">4</span>
                <h2 class="text-gray-900 font-bold text-lg">å’Œè§£æ¢ä»¶èˆ‡è³ å„Ÿ</h2>
            </div>

            <div class="grid grid-cols-3 gap-2">
                <button type="button" onclick="setMode('A_PAY_B')" id="btnAPayB" class="mode-btn border border-blue-200 bg-blue-50 p-3 rounded-lg text-sm font-bold text-blue-700 transition-all">ç”²æ–¹è³ ä¹™æ–¹</button>
                <button type="button" onclick="setMode('B_PAY_A')" id="btnBPayA" class="mode-btn border border-gray-200 p-3 rounded-lg text-sm text-gray-600 transition-all">ä¹™æ–¹è³ ç”²æ–¹</button>
                <button type="button" onclick="setMode('NO_PAY')" id="btnNoPay" class="mode-btn border border-gray-200 p-3 rounded-lg text-sm text-gray-600 transition-all">äº’ä¸è³ å„Ÿ</button>
            </div>
            <input type="hidden" id="settleMode" value="A_PAY_B">

            <div id="moneySection" class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 space-y-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold">è³ å„Ÿé‡‘é¡ (æ–°å°å¹£)</label>
                    <input type="number" id="amount" class="block w-full p-2 border border-gray-300 text-2xl font-bold rounded bg-white text-right" placeholder="0">
                </div>
                
                <div>
                    <label class="text-xs text-gray-700 font-bold mb-1 block">ä¿éšªç†è³ è™•ç†æ–¹å¼ <span class="text-red-500">*</span></label>
                    <label class="radio-box" id="boxInsExclude" onclick="selectInsurance('exclude')">
                        <input type="radio" name="insuranceOption" value="exclude" checked>
                        <div>
                            <div class="font-bold text-sm text-gray-800">ä¸åŒ…å«ä¿éšª (ä¿éšªè„«é‰¤)</div>
                            <div class="text-xs text-gray-500 leading-tight">æœ¬å’Œè§£é‡‘åƒ…é‡å°ã€Œè‡ªä»˜é¡ã€éƒ¨åˆ†ã€‚é›™æ–¹ä»å¯å„è‡ªå‘å°æ–¹ä¿éšªå…¬å¸ç”³è«‹ç†è³ ï¼Œä¿éšªå…¬å¸å¯ä»£ä½æ±‚å„Ÿã€‚</div>
                        </div>
                    </label>
                    <label class="radio-box" id="boxInsInclude" onclick="selectInsurance('include')">
                        <input type="radio" name="insuranceOption" value="include">
                        <div>
                            <div class="font-bold text-sm text-red-700">åŒ…å«ä¿éšª (ä¿éšªæ–·å°¾)</div>
                            <div class="text-xs text-gray-500 leading-tight">å’Œè§£é‡‘å·²åŒ…å«å¼·åˆ¶éšªåŠä»»æ„éšªã€‚é›™æ–¹è‡ªè¡Œå¸æ”¶æå¤±ï¼Œ<strong class="text-red-600">æ‰¿è«¾ä¸ç”³è«‹ä¿éšªç†è³ ï¼Œä¸¦é˜»æ–·ä¿éšªå…¬å¸ä»£ä½æ±‚å„Ÿæ¬Šã€‚</strong></div>
                        </div>
                    </label>
                </div>

                <hr class="border-yellow-200">

                <div class="space-y-2">
                    <label class="flex items-center text-sm font-bold text-gray-700">
                        <input type="radio" name="payMethod" value="cash" checked onclick="toggleBankInfo(false)" class="mr-2"> 
                        ç¾å ´ç¾é‡‘ä»˜æ¸… <span class="text-xs font-normal text-gray-500 ml-1">(ä¸å¦ç«‹æ”¶æ“š)</span>
                    </label>
                    <label class="flex items-center text-sm font-bold text-gray-700">
                        <input type="radio" name="payMethod" value="transfer" onclick="toggleBankInfo(true)" class="mr-2"> 
                        ç¾å ´è½‰å¸³/åŒ¯æ¬¾
                    </label>
                    <div id="bankInfo" class="hidden pl-6 pt-1">
                        <input type="text" id="bankAccount" placeholder="è¼¸å…¥æ”¶æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ (ä¾›æ ¸å°ç”¨)" class="w-full border rounded p-2 text-sm bg-white">
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. ç°½ç½²èˆ‡è­‰æ“š -->
        <section class="space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">5</span>
                <h2 class="text-gray-900 font-bold text-lg">ç°½ç½²èˆ‡è­‰æ“š</h2>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <p class="text-sm font-bold text-blue-800 text-center">ç”²æ–¹ç°½ç½²</p>
                    <div id="previewSigA" onclick="openSigModal('A')" class="h-24 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 flex flex-col items-center justify-center cursor-pointer hover:bg-blue-100 transition">
                        <span class="text-blue-400 text-2xl mb-1">âœï¸</span>
                        <span class="text-blue-400 text-xs">é»æ“Šç°½å</span>
                    </div>
                    <input type="hidden" id="sigDataA">

                    <div id="repSigBoxA" class="hidden">
                         <div id="previewSigRepA" onclick="openSigModal('RepA')" class="h-20 border-2 border-dashed border-red-300 rounded-lg bg-red-50 flex flex-col items-center justify-center cursor-pointer mt-2">
                            <span class="text-red-400 text-xs">æ³•å®šä»£ç†äººç°½å</span>
                        </div>
                        <input type="hidden" id="sigDataRepA">
                    </div>
                </div>

                <div class="space-y-2">
                    <p class="text-sm font-bold text-orange-800 text-center">ä¹™æ–¹ç°½ç½²</p>
                    <div id="previewSigB" onclick="openSigModal('B')" class="h-24 border-2 border-dashed border-orange-300 rounded-lg bg-orange-50 flex flex-col items-center justify-center cursor-pointer hover:bg-orange-100 transition">
                        <span class="text-orange-400 text-2xl mb-1">âœï¸</span>
                        <span class="text-orange-400 text-xs">é»æ“Šç°½å</span>
                    </div>
                    <input type="hidden" id="sigDataB">

                    <div id="repSigBoxB" class="hidden">
                         <div id="previewSigRepB" onclick="openSigModal('RepB')" class="h-20 border-2 border-dashed border-red-300 rounded-lg bg-red-50 flex flex-col items-center justify-center cursor-pointer mt-2">
                            <span class="text-red-400 text-xs">æ³•å®šä»£ç†äººç°½å</span>
                        </div>
                        <input type="hidden" id="sigDataRepB">
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mt-4">
                <div class="flex justify-between items-end mb-2">
                    <label class="block text-sm font-bold text-gray-700">äº‹æ•…ç¾å ´/è»Šæç…§ç‰‡ (å°‡é™„æ–¼ç¬¬äºŒé )</label>
                    <button type="button" onclick="document.getElementById('multiPhotoInput').click()" class="bg-slate-600 text-white px-3 py-1.5 rounded shadow text-xs font-bold flex items-center gap-1">
                        <span>ğŸ“·</span> æ–°å¢ç…§ç‰‡
                    </button>
                </div>
                <input type="file" id="multiPhotoInput" accept="image/*" multiple class="hidden" onchange="handleMultiPhotos(this)">
                
                <div id="evidenceGrid" class="photo-grid">
                    <div class="text-center text-gray-400 text-xs col-span-3 py-4 border border-dashed rounded">
                        å°šæœªä¸Šå‚³ç…§ç‰‡<br>(å»ºè­°æ‹æ”è»Šæéƒ¨ä½ã€ç¾å ´å…¨æ™¯)
                    </div>
                </div>
            </div>
        </section>

        <div class="pt-4 pb-8">
            <button type="button" onclick="generatePDF()" class="w-full bg-gradient-to-br from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-bold py-4 rounded-xl shadow-xl text-lg flex items-center justify-center gap-2 transform transition active:scale-95">
                <span>ğŸ“„</span> ç”¢ç”Ÿæ­£å¼å’Œè§£æ›¸ PDF
            </button>
            <p class="text-center text-xs text-gray-400 mt-3">
                *ç³»çµ±å°‡è‡ªå‹•åŠ è“‹æ•¸ä½é¨ç¸«ç« ï¼Œè«‹ç¨å€™ 3-5 ç§’
            </p>
        </div>
    </form>
</div>

<!-- ================= PDF TEMPLATES (HIDDEN) ================= -->
<div id="preview-container">
    <div id="preview-page1" class="pdf-page">
        <div class="pdf-title">äº¤é€šäº‹æ•…å’Œè§£æ›¸</div>
        <div class="flex justify-between items-end mb-4 border-b pb-2">
            <div class="text-sm text-gray-600">æ¡ˆä»¶ç·¨è™Ÿï¼š<span id="pdfRefId"></span></div>
            <div class="text-sm font-bold">æ—¥æœŸï¼š<span id="pdfDate"></span></div>
        </div>

        <div class="pdf-party-box">
            <div class="pdf-party-col border-r mr-4 pr-4">
                <strong>ç”²æ–¹ (Party A)</strong>
                å§“åï¼š<span id="pdfNameA"></span><br>
                èº«åˆ†è­‰ï¼š<span id="pdfIdA"></span><br>
                è»Šè™Ÿï¼š<span id="pdfPlateA"></span>
                <div id="pdfRepInfoA" class="hidden mt-1 pt-1 border-t border-dashed text-xs text-gray-600">
                    æ³•å®šä»£ç†ï¼š<span id="pdfRepNameA"></span>
                </div>
            </div>
            <div class="pdf-party-col">
                <strong>ä¹™æ–¹ (Party B)</strong>
                å§“åï¼š<span id="pdfNameB"></span><br>
                èº«åˆ†è­‰ï¼š<span id="pdfIdB"></span><br>
                è»Šè™Ÿï¼š<span id="pdfPlateB"></span>
                <div id="pdfRepInfoB" class="hidden mt-1 pt-1 border-t border-dashed text-xs text-gray-600">
                    æ³•å®šä»£ç†ï¼š<span id="pdfRepNameB"></span>
                </div>
            </div>
        </div>

        <div class="pdf-section-title">ä¸€ã€äº‹æ•…æ¡ˆç”±</div>
        <p class="pdf-text">
            èŒ²å› é›™æ–¹æ–¼ä¸­è¯æ°‘åœ‹ <span id="pdfIncidentDateStr"></span> <span id="pdfIncidentTime"></span>ï¼Œ
            åœ¨ <span id="pdfLocation"></span> ç™¼ç”Ÿ <span id="pdfType"></span> ä¹‹äº¤é€šäº‹æ•…ï¼Œè‡´é›™æ–¹è»Šè¼›å—æã€‚
            <span id="pdfInjuryText" class="pdf-highlight"></span>
        </p>

        <div class="pdf-section-title">äºŒã€å’Œè§£æ¢ä»¶</div>
        <ol class="pdf-list">
            <li id="pdfMainTerm" class="font-bold mb-2"></li>
            <li id="pdfPayDetail"></li>
            <li>
                æœ¬æ¡ˆç‚ºä¸€æ¬¡æ€§è§£æ±ºã€‚é™¤æœ¬å’Œè§£æ›¸ç´„å®šä¹‹è³ å„Ÿé‡‘é¡å¤–ï¼Œé›™æ–¹å‡æ‹‹æ£„å°æœ¬æ¡ˆå…¶é¤˜ä¸€åˆ‡æ°‘äº‹è«‹æ±‚æ¬Šï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼è»Šè¼›è²¶å€¼æå¤±ã€ç‡Ÿæ¥­æå¤±ã€äº¤é€šä»£æ­¥è²»ã€ç²¾ç¥æ…°æ’«é‡‘ç­‰ï¼‰ã€‚
            </li>
            <li>
                é›™æ–¹åŒæ„ä¸å†è¿½ç©¶å°æ–¹ä¹‹åˆ‘äº‹è²¬ä»»ï¼ˆå«éå¤±å‚·å®³ç­‰ï¼‰ã€‚å¦‚ä»»ä¸€æ–¹å·²æå‡ºåˆ‘äº‹å‘Šè¨´ï¼Œæ‡‰å³å…·ç‹€æ’¤å›ã€‚
            </li>
            <li id="pdfInsuranceClause"></li>
            <li id="pdfOwnerClauseA" class="hidden">
                ç”²æ–¹è²æ˜ï¼šé§•é§›äººé›–éè»Šä¸»ï¼Œä½†å·²ç²è»Šè¼›æ‰€æœ‰äººå……åˆ†æˆæ¬Šå…¨æ¬Šè™•ç†æœ¬æ¡ˆåŠæ”¶å—å’Œè§£é‡‘ï¼Œè‹¥æœ‰çˆ­è­°æ¦‚ç”±é§•é§›äººè² å®Œå…¨è²¬ä»»ã€‚
            </li>
            <li id="pdfOwnerClauseB" class="hidden">
                ä¹™æ–¹è²æ˜ï¼šé§•é§›äººé›–éè»Šä¸»ï¼Œä½†å·²ç²è»Šè¼›æ‰€æœ‰äººå……åˆ†æˆæ¬Šå…¨æ¬Šè™•ç†æœ¬æ¡ˆåŠæ”¶å—å’Œè§£é‡‘ï¼Œè‹¥æœ‰çˆ­è­°æ¦‚ç”±é§•é§›äººè² å®Œå…¨è²¬ä»»ã€‚
            </li>
        </ol>

        <div class="pdf-sig-container">
            <div class="pdf-sig-box">
                <p class="font-bold mb-2 text-center bg-gray-100 p-1">ç”²æ–¹ç°½ç« </p>
                <img id="pdfSigA" class="pdf-sig-img">
                <div class="text-xs text-gray-500">ç°½ç½²äººï¼š<span id="pdfSigNameA"></span></div>
                <div id="pdfRepSigContainerA" class="hidden mt-2">
                    <p class="text-xs font-bold text-gray-600">æ³•å®šä»£ç†äºº</p>
                    <img id="pdfSigRepA" class="pdf-sig-img h-10">
                    <div class="text-xs text-gray-500"><span id="pdfRepSigNameA"></span></div>
                </div>
            </div>
            <div class="pdf-sig-box">
                <p class="font-bold mb-2 text-center bg-gray-100 p-1">ä¹™æ–¹ç°½ç« </p>
                <img id="pdfSigB" class="pdf-sig-img">
                <div class="text-xs text-gray-500">ç°½ç½²äººï¼š<span id="pdfSigNameB"></span></div>
                <div id="pdfRepSigContainerB" class="hidden mt-2">
                    <p class="text-xs font-bold text-gray-600">æ³•å®šä»£ç†äºº</p>
                    <img id="pdfSigRepB" class="pdf-sig-img h-10">
                    <div class="text-xs text-gray-500"><span id="pdfRepSigNameB"></span></div>
                </div>
            </div>
        </div>

        <div class="footer-note">
            Digital Document Generated via SettlementHelper v2.4 | <span id="pdfTimestamp"></span> | <span id="pdfUserAgent"></span>
        </div>
    </div>

    <div id="preview-page2" class="pdf-page hidden">
        <div class="pdf-title" style="font-size: 20px; border:none; margin-bottom: 10px;">é™„ä»¶ï¼šç¾å ´åŠè»Šæç´€éŒ„</div>
        <div class="text-right text-sm text-gray-500 mb-4">æ¡ˆä»¶ç·¨è™Ÿï¼š<span id="pdfRefId2"></span></div>
        <div id="pdfPhotoGrid" class="grid grid-cols-2 gap-6"></div>
        <div class="footer-note">
            æ­¤é é¢ç‚ºå’Œè§£æ›¸ä¹‹é™„ä»¶ï¼Œèˆ‡æ­£æœ¬å…·åŒç­‰æ•ˆåŠ›ã€‚
        </div>
    </div>
</div>

<canvas id="sealCanvas" width="100" height="320" style="display:none;"></canvas>

<script>
    const { jsPDF } = window.jspdf;
    let signaturePad = null, currentSigner = null;
    let evidencePhotos = [];
    
    const now = new Date();
    document.getElementById('incidentDate').value = now.toISOString().slice(0, 10);
    document.getElementById('incidentTime').value = now.toTimeString().slice(0, 5);

    function initPad() {
        const canvas = document.getElementById('signature-pad');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        const ctx = canvas.getContext("2d");
        ctx.scale(ratio, ratio);
        signaturePad = new SignaturePad(canvas, { minWidth: 1, maxWidth: 2.5, penColor: "black" });
    }

    function checkAge(party) {
        const dobInput = document.getElementById(`dob${party}`);
        const repArea = document.getElementById(`repArea${party}`);
        const repSigBox = document.getElementById(`repSigBox${party}`);
        
        if(!dobInput.value) return;
        const dob = new Date(dobInput.value);
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }

        if(age < 18) {
            repArea.classList.remove('hidden');
            repSigBox.classList.remove('hidden');
            repArea.scrollIntoView({behavior: 'smooth', block: 'center'});
        } else {
            repArea.classList.add('hidden');
            repSigBox.classList.add('hidden');
            document.getElementById(`repName${party}`).value = "";
            document.getElementById(`repId${party}`).value = "";
            document.getElementById(`sigDataRep${party}`).value = "";
            document.getElementById(`previewSigRep${party}`).innerHTML = `<span class="text-red-400 text-xs">æ³•å®šä»£ç†äººç°½å</span>`;
        }
    }

    function toggleCustomType() {
        const isOther = document.getElementById('incidentType').value === 'å…¶ä»–';
        document.getElementById('incidentTypeCustom').classList.toggle('hidden', !isOther);
    }

    function setMode(mode) {
        document.querySelectorAll('.mode-btn').forEach(b => {
            b.className = 'mode-btn border border-gray-200 p-3 rounded-lg text-sm text-gray-600 transition-all';
        });
        let btnId = 'btnNoPay';
        if(mode === 'A_PAY_B') btnId = 'btnAPayB';
        else if(mode === 'B_PAY_A') btnId = 'btnBPayA';

        const btn = document.getElementById(btnId);
        btn.className = 'mode-btn border border-blue-500 bg-blue-50 p-3 rounded-lg text-sm font-bold text-blue-700 ring-2 ring-blue-200 transition-all';
        document.getElementById('settleMode').value = mode;
        document.getElementById('moneySection').classList.toggle('hidden', mode === 'NO_PAY');
    }

    function selectInsurance(type) {
        const exBox = document.getElementById('boxInsExclude');
        const inBox = document.getElementById('boxInsInclude');
        if(type === 'exclude') {
            exBox.classList.add('selected');
            inBox.classList.remove('selected');
            document.querySelector('input[value="exclude"]').checked = true;
        } else {
            exBox.classList.remove('selected');
            inBox.classList.add('selected');
            document.querySelector('input[value="include"]').checked = true;
        }
    }
    selectInsurance('exclude');

    function toggleBankInfo(show) {
        document.getElementById('bankInfo').classList.toggle('hidden', !show);
    }

    function getLocation() {
        const el = document.getElementById('incidentLocation');
        if (!navigator.geolocation) { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"); return; }
        el.placeholder = "æ­£åœ¨ç²å–ä½ç½®...";
        navigator.geolocation.getCurrentPosition(async (p) => {
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&accept-language=zh-TW`);
                const d = await r.json();
                let addr = d.address.road || d.address.suburb || "";
                if(d.address.city) addr = d.address.city + addr;
                else if(d.address.county) addr = d.address.county + addr;
                el.value = addr || `${p.coords.latitude}, ${p.coords.longitude}`;
            } catch { el.value = `${p.coords.latitude}, ${p.coords.longitude}`; }
        }, () => { alert("ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹æ‰‹å‹•è¼¸å…¥"); el.placeholder = "è«‹è¼¸å…¥åœ°é»"; });
    }

    function openSigModal(s) {
        currentSigner = s;
        const map = { 'A': 'ç”²æ–¹ (é§•é§›äºº)', 'B': 'ä¹™æ–¹ (é§•é§›äºº)', 'RepA': 'ç”²æ–¹ æ³•å®šä»£ç†äºº', 'RepB': 'ä¹™æ–¹ æ³•å®šä»£ç†äºº' };
        document.getElementById('sigModalTitle').innerText = `è«‹ç°½åï¼š${map[s]}`;
        document.getElementById('sigModal').style.display = 'block';
        setTimeout(initPad, 100);
    }
    function closeSigModal() { document.getElementById('sigModal').style.display = 'none'; }
    function clearCurrentPad() { if(signaturePad) signaturePad.clear(); }
    function saveSignature() {
        if(signaturePad.isEmpty()) return alert("è«‹å…ˆç°½å");
        const data = signaturePad.toDataURL();
        document.getElementById(`sigData${currentSigner}`).value = data;
        const preview = document.getElementById(`previewSig${currentSigner}`);
        preview.innerHTML = `<img src="${data}" class="h-full object-contain">`;
        preview.classList.remove('border-dashed');
        preview.classList.add('border-solid', 'bg-white');
        closeSigModal();
    }

    function handleMultiPhotos(input) {
        if (!input.files) return;
        const grid = document.getElementById('evidenceGrid');
        if(evidencePhotos.length === 0) grid.innerHTML = '';
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => {
                evidencePhotos.push(e.target.result);
                const d = document.createElement('div');
                d.className = 'photo-item';
                d.innerHTML = `<img src="${e.target.result}"><div class="photo-delete" onclick="this.parentNode.remove(); removePhoto('${e.target.result}')">Ã—</div>`;
                grid.appendChild(d);
            };
            r.readAsDataURL(f);
        });
        input.value = '';
    }
    function removePhoto(src) {
        evidencePhotos = evidencePhotos.filter(p => p !== src);
        if(evidencePhotos.length === 0) {
            document.getElementById('evidenceGrid').innerHTML = '<div class="text-center text-gray-400 text-xs col-span-3 py-4 border border-dashed rounded">å°šæœªä¸Šå‚³ç…§ç‰‡<br>(å»ºè­°æ‹æ”è»Šæéƒ¨ä½ã€ç¾å ´å…¨æ™¯)</div>';
        }
    }

    function checkTWID(id) {
        id = id.toUpperCase();
        if (!/^[A-Z][1289]\d{8}$/.test(id)) return { valid: false, msg: "æ ¼å¼éŒ¯èª¤ (è‹±æ–‡å­—æ¯+9ç¢¼æ•¸å­—)" };
        const letterMap = { A: 10, B: 11, C: 12, D: 13, E: 14, F: 15, G: 16, H: 17, J: 18, K: 19, L: 20, M: 21, N: 22, P: 23, Q: 24, R: 25, S: 26, T: 27, U: 28, V: 29, X: 30, Y: 31, W: 32, Z: 33, I: 34, O: 35 };
        const n = letterMap[id[0]];
        if (!n) return { valid: false, msg: "é¦–ç¢¼éŒ¯èª¤" };
        const n1 = Math.floor(n / 10);
        const n2 = n % 10;
        const d = id.substring(1).split('').map(Number);
        const weights = [8, 7, 6, 5, 4, 3, 2, 1];
        let sum = n1 * 1 + n2 * 9;
        for (let i = 0; i < 8; i++) { sum += d[i] * weights[i]; }
        const checkDigit = (10 - (sum % 10)) % 10;
        if (checkDigit === d[8]) return { valid: true, msg: "" };
        else return { valid: false, msg: "æª¢æŸ¥ç¢¼éŒ¯èª¤" };
    }

    function validateID(el) {
        const id = el.value.toUpperCase();
        el.value = id;
        const errEl = document.getElementById('error' + el.id.charAt(0).toUpperCase() + el.id.slice(1));
        if(!id) {
            el.classList.remove('border-red-500', 'bg-red-50', 'border-green-500');
            if(errEl) errEl.style.display = 'none';
            return;
        }
        const result = checkTWID(id);
        if (!result.valid) {
            el.classList.add('border-red-500', 'bg-red-50');
            el.classList.remove('border-green-500');
            if(errEl) { errEl.innerText = result.msg; errEl.style.display = 'block'; }
        } else {
            el.classList.remove('border-red-500', 'bg-red-50');
            el.classList.add('border-green-500');
            if(errEl) errEl.style.display = 'none';
        }
    }

    function generateSeal() {
        const c = document.getElementById('sealCanvas');
        const ctx = c.getContext('2d');
        const cx = 50, cy = 160; 
        ctx.clearRect(0, 0, 100, 320);
        ctx.beginPath();
        ctx.ellipse(cx, cy, 38, 130, 0, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(220, 38, 38, 0.15)'; 
        ctx.fill();
        ctx.lineWidth = 5; 
        ctx.strokeStyle = '#b91c1c'; 
        ctx.stroke();
        ctx.beginPath();
        ctx.ellipse(cx, cy, 34, 126, 0, 0, 2 * Math.PI);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#b91c1c';
        ctx.stroke();
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-Math.PI / 2); 
        ctx.font = "bold 24px 'Microsoft JhengHei', 'Heiti TC', sans-serif";
        ctx.fillStyle = "#b91c1c";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("â˜… é¨ç¸«ç« ãƒ»å’Œè§£å¥‘ç´„ â˜…", 0, 0);
        ctx.restore();
        return c.toDataURL();
    }

    async function generatePDF() {
        if(!document.getElementById('nameA').value || !document.getElementById('nameB').value) return alert("è«‹å¡«å¯«é›™æ–¹å§“å");
        if(!document.getElementById('sigDataA').value) return alert("ç”²æ–¹å°šæœªç°½å");
        if(!document.getElementById('sigDataB').value) return alert("ä¹™æ–¹å°šæœªç°½å");

        const repA = document.getElementById('repAreaA').classList.contains('hidden') ? false : true;
        if(repA && !document.getElementById('sigDataRepA').value) return alert("ç”²æ–¹æœªæ»¿ 18 æ­²ï¼Œéœ€æ³•å®šä»£ç†äººç°½å");
        const repB = document.getElementById('repAreaB').classList.contains('hidden') ? false : true;
        if(repB && !document.getElementById('sigDataRepB').value) return alert("ä¹™æ–¹æœªæ»¿ 18 æ­²ï¼Œéœ€æ³•å®šä»£ç†äººç°½å");

        document.getElementById('loader').style.display = 'flex';

        const dateVal = document.getElementById('incidentDate').value;
        const refId = dateVal.replace(/-/g, '') + '-' + Math.floor(Math.random()*1000);
        document.getElementById('pdfRefId').innerText = refId;
        document.getElementById('pdfRefId2').innerText = refId;
        document.getElementById('pdfDate').innerText = dateVal;
        document.getElementById('pdfIncidentDateStr').innerText = dateVal;
        document.getElementById('pdfIncidentTime').innerText = document.getElementById('incidentTime').value;
        document.getElementById('pdfLocation').innerText = document.getElementById('incidentLocation').value;
        
        const typeVal = document.getElementById('incidentType').value;
        document.getElementById('pdfType').innerText = (typeVal === 'å…¶ä»–') ? document.getElementById('incidentTypeCustom').value : typeVal;
        const noInjury = document.getElementById('noInjuryCheck').checked;
        document.getElementById('pdfInjuryText').innerText = noInjury 
            ? "(â€» é›™æ–¹æ–¼äº‹æ•…ç¾å ´ç¢ºèªèº«é«”å‡ç„¡ä¸é©ï¼Œä¸”å¤–è§€ç„¡æ˜é¡¯å‚·å‹¢ã€‚)" 
            : "(â€» è¨»ï¼šæœ¬æ¡ˆæ¶‰åŠäººå“¡å—å‚·ï¼Œå»ºè­°åƒ…å°±è»Šæéƒ¨åˆ†å…ˆè¡Œå’Œè§£ï¼Œæˆ–ç¢ºèªå‚·å‹¢å·²ç„¡å¤§ç¤™ã€‚)";

        document.getElementById('pdfNameA').innerText = document.getElementById('nameA').value;
        document.getElementById('pdfIdA').innerText = document.getElementById('idA').value;
        document.getElementById('pdfPlateA').innerText = document.getElementById('plateA').value;
        if(repA) {
            document.getElementById('pdfRepInfoA').classList.remove('hidden');
            document.getElementById('pdfRepNameA').innerText = document.getElementById('repNameA').value;
            document.getElementById('pdfRepSigContainerA').classList.remove('hidden');
            document.getElementById('pdfSigRepA').src = document.getElementById('sigDataRepA').value;
            document.getElementById('pdfRepSigNameA').innerText = document.getElementById('repNameA').value;
        } else {
            document.getElementById('pdfRepInfoA').classList.add('hidden');
            document.getElementById('pdfRepSigContainerA').classList.add('hidden');
        }

        document.getElementById('pdfNameB').innerText = document.getElementById('nameB').value;
        document.getElementById('pdfIdB').innerText = document.getElementById('idB').value;
        document.getElementById('pdfPlateB').innerText = document.getElementById('plateB').value;
        if(repB) {
            document.getElementById('pdfRepInfoB').classList.remove('hidden');
            document.getElementById('pdfRepNameB').innerText = document.getElementById('repNameB').value;
            document.getElementById('pdfRepSigContainerB').classList.remove('hidden');
            document.getElementById('pdfSigRepB').src = document.getElementById('sigDataRepB').value;
            document.getElementById('pdfRepSigNameB').innerText = document.getElementById('repNameB').value;
        } else {
            document.getElementById('pdfRepInfoB').classList.add('hidden');
            document.getElementById('pdfRepSigContainerB').classList.add('hidden');
        }

        const mode = document.getElementById('settleMode').value;
        const amt = document.getElementById('amount').value;
        const payMethod = document.querySelector('input[name="payMethod"]:checked').value;
        
        const insuranceMode = document.querySelector('input[name="insuranceOption"]:checked').value;
        const insuranceLi = document.getElementById('pdfInsuranceClause');
        if (insuranceMode === 'exclude') {
            insuranceLi.innerHTML = `<strong>ä¿éšªè„«é‰¤æ¢æ¬¾ï¼ˆä¸å«ä¿éšªï¼‰ï¼š</strong>æœ¬å’Œè§£é‡‘é¡<span class="text-red-600 font-bold">ä¸åŒ…å«</span>å¼·åˆ¶æ±½è»Šè²¬ä»»ä¿éšªåŠä»»æ„ç¬¬ä¸‰äººè²¬ä»»ä¿éšªä¹‹ç†è³ ã€‚é›™æ–¹åŒæ„ç”±å„è‡ªä¿éšªå…¬å¸ä¾ç´„è™•ç†ï¼Œä½†ä¸å¾—å½±éŸ¿æœ¬å’Œè§£æ›¸é—œæ–¼åˆ‘äº‹è²¬ä»»æ‹‹æ£„ä¹‹æ•ˆåŠ›ã€‚`;
        } else {
            insuranceLi.innerHTML = `<strong>ä¿éšªæ–·å°¾æ¢æ¬¾ï¼ˆå«å¼·åˆ¶éšª/ä»»æ„éšªï¼‰ï¼š</strong>æœ¬å’Œè§£é‡‘é¡<span class="text-red-600 font-bold">å·²åŒ…å«</span>å¼·åˆ¶æ±½è»Šè²¬ä»»ä¿éšªã€ç¬¬ä¸‰äººè²¬ä»»ä¿éšªåŠå…¶ä»–ä¸€åˆ‡ä¿éšªç†è³ ã€‚é›™æ–¹åŒæ„è‡ªè¡Œæ‰¿æ“”å„è‡ªæå¤±ï¼Œäº’ä¸ç”³è«‹ä¿éšªç†è³ ï¼Œä¸¦æ‹‹æ£„å°å°æ–¹åŠå…¶ä¿éšªå…¬å¸ä¹‹ä¸€åˆ‡è«‹æ±‚æ¬Šã€‚`;
        }

        let mainText = "";
        let subText = "";
        if(mode === 'NO_PAY') {
            mainText = "é›™æ–¹è‡ªè¡Œè² æ“”å„è‡ªæå¤±ï¼Œäº’ä¸è¦æ±‚è³ å„Ÿã€‚";
        } else {
            const payer = (mode === 'A_PAY_B') ? "ç”²æ–¹" : "ä¹™æ–¹";
            const receiver = (mode === 'A_PAY_B') ? "ä¹™æ–¹" : "ç”²æ–¹";
            mainText = `${payer} é¡˜è³ å„Ÿ ${receiver} æ–°å°å¹£ ${amt} å…ƒæ•´ã€‚`;
            if(payMethod === 'cash') {
                subText = "ä¸Šé–‹é‡‘é¡å·²æ–¼ç¾å ´ä»¥ç¾é‡‘ä»˜æ¸…ï¼Œä¸å¦ç«‹æ”¶æ“šï¼Œé›™æ–¹ç¢ºèªé»æ”¶ç„¡èª¤ã€‚";
            } else {
                const acc = document.getElementById('bankAccount').value;
                subText = `ä»˜æ¬¾æ–¹å¼ï¼šç¾å ´è½‰å¸³/åŒ¯æ¬¾ã€‚${acc ? '(æ”¶æ¬¾å¸³æˆ¶æœ«äº”ç¢¼ï¼š'+acc+')' : ''}`;
            }
        }
        
        document.getElementById('pdfMainTerm').innerText = mainText;
        document.getElementById('pdfPayDetail').innerText = subText;

        const ownerA = document.getElementById('isOwnerA').checked;
        const ownerB = document.getElementById('isOwnerB').checked;
        document.getElementById('pdfOwnerClauseA').classList.toggle('hidden', ownerA);
        document.getElementById('pdfOwnerClauseB').classList.toggle('hidden', ownerB);

        document.getElementById('pdfSigA').src = document.getElementById('sigDataA').value;
        document.getElementById('pdfSigNameA').innerText = document.getElementById('nameA').value;
        document.getElementById('pdfSigB').src = document.getElementById('sigDataB').value;
        document.getElementById('pdfSigNameB').innerText = document.getElementById('nameB').value;

        document.getElementById('pdfTimestamp').innerText = new Date().toLocaleString();
        document.getElementById('pdfUserAgent').innerText = "IP Logged"; 

        const p2 = document.getElementById('preview-page2');
        const grid = document.getElementById('pdfPhotoGrid');
        grid.innerHTML = '';
        const hasPhotos = evidencePhotos.length > 0;

        if(hasPhotos) {
            p2.classList.remove('hidden');
            evidencePhotos.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = "w-full h-64 object-cover border border-gray-300 rounded";
                grid.appendChild(img);
            });
        } else {
            p2.classList.add('hidden');
        }

        try {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            
            const p1C = await html2canvas(document.getElementById('preview-page1'), { scale: 2, useCORS: true });
            pdf.addImage(p1C.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, w, h);

            if(hasPhotos) {
                const sealData = generateSeal();
                const sealW = 26; 
                const sealH = 80; 
                const sealY = 140;
                pdf.addImage(sealData, 'PNG', 198, sealY, sealW, sealH);
                pdf.addPage();
                const p2C = await html2canvas(document.getElementById('preview-page2'), { scale: 2, useCORS: true });
                pdf.addImage(p2C.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, w, h);
                pdf.addImage(sealData, 'PNG', -13, sealY, sealW, sealH);
            }

            const filename = `è»Šç¦å’Œè§£æ›¸_${refId}.pdf`;
            const blob = pdf.output('blob');
            const file = new File([blob], filename, { type: "application/pdf" });

            // === ANDROID PERMISSION FIX ===
            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({ files: [file], title: 'è»Šç¦å’Œè§£æ›¸' });
                } catch (shareError) {
                    console.warn("Share failed, falling back to download", shareError);
                    pdf.save(filename); // Fallback for "Permission denied"
                }
            } else {
                pdf.save(filename);
            }

        } catch (e) {
            console.error(e);
            alert("PDF ç”¢ç”Ÿå¤±æ•—ï¼š" + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>
</body>
</html>